<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LibraryAI</title>
<style>
  :root {
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --primary-light: rgba(37,99,235,0.08);
    --bg: #f0f2f5;
    --surface: #fff;
    --border: #e5e7eb;
    --text: #1f2937;
    --text-muted: #6b7280;
    --text-faint: #9ca3af;
    --danger: #dc2626;
    --sidebar-w: 260px;
    --logs-w: 360px;
  }

  [data-theme="dark"] {
    --primary: #3b82f6;
    --primary-hover: #60a5fa;
    --primary-light: rgba(59,130,246,0.12);
    --bg: #111827;
    --surface: #1f2937;
    --border: #374151;
    --text: #f3f4f6;
    --text-muted: #9ca3af;
    --text-faint: #6b7280;
    --danger: #ef4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ===== Header ===== */
  header {
    background: var(--primary);
    color: #fff;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    z-index: 10;
  }

  .header-left { display: flex; align-items: center; gap: 10px; }

  #sidebar-toggle {
    background: none; border: none; color: #fff; cursor: pointer;
    font-size: 1.25rem; padding: 4px 6px; border-radius: 4px;
  }
  #sidebar-toggle:hover { background: rgba(255,255,255,0.15); }

  header h1 { font-size: 1.15rem; font-weight: 600; }

  .header-controls { display: flex; gap: 6px; align-items: center; }

  header select, header button {
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    font-size: 0.82rem;
    background: rgba(255,255,255,0.15);
    color: #fff;
    cursor: pointer;
  }

  header button:hover { background: rgba(255,255,255,0.25); }
  header button:disabled { opacity: 0.5; cursor: not-allowed; }
  header select option { color: #333; background: #fff; }

  /* ===== Layout ===== */
  .app-body {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* ===== Sidebar ===== */
  .sidebar {
    width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
    transition: margin-left 0.2s ease;
  }

  .sidebar.collapsed {
    margin-left: calc(-1 * var(--sidebar-w));
  }

  .sidebar-header {
    padding: 12px 14px 8px;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 6px 0;
  }

  .scope-item {
    padding: 8px 14px;
    font-size: 0.88rem;
    cursor: pointer;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .scope-item:hover { background: var(--primary-light); }
  .scope-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }

  .series-header {
    padding: 8px 14px 4px;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    user-select: none;
  }
  .series-header:hover { color: var(--text); }

  .series-arrow {
    font-size: 0.7rem;
    transition: transform 0.15s;
  }
  .series-header.open .series-arrow { transform: rotate(90deg); }

  .series-books { display: none; }
  .series-header.open + .series-books { display: block; }

  .scope-item.book-item { padding-left: 28px; font-size: 0.85rem; }

  .sidebar-loading {
    padding: 20px 14px;
    color: var(--text-muted);
    font-size: 0.85rem;
    text-align: center;
  }

  .summarize-btn {
    display: none;
    margin: 8px 14px;
    padding: 6px 12px;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    width: calc(100% - 28px);
  }
  .summarize-btn:hover { background: var(--primary-hover); }
  .summarize-btn:disabled { background: #93c5fd; cursor: not-allowed; }
  .summarize-btn.visible { display: block; }

  /* ===== Main area ===== */
  .main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 0;
  }

  /* ===== Scope badge ===== */
  .scope-badge-bar {
    display: none;
    padding: 6px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .scope-badge-bar.visible { display: flex; align-items: center; gap: 8px; }

  .scope-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    background: var(--primary-light);
    color: var(--primary);
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .scope-badge button {
    background: none; border: none; color: var(--primary);
    cursor: pointer; font-size: 0.9rem; padding: 0 2px;
    line-height: 1;
  }

  .scope-badge-label { color: var(--text-muted); font-size: 0.8rem; }

  /* ===== Setup Banner ===== */
  #setup-banner {
    display: none;
    max-width: 480px;
    margin: 40px auto;
    padding: 32px;
    background: var(--surface);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    text-align: center;
  }

  #setup-banner h2 { font-size: 1.3rem; margin-bottom: 8px; color: var(--text); }
  #setup-banner p { color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; line-height: 1.5; }

  #setup-banner input[type="text"] {
    width: 100%; padding: 10px 14px;
    border: 1px solid #d1d5db; border-radius: 8px;
    font-size: 0.95rem; outline: none; margin-bottom: 12px;
  }
  #setup-banner input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.15); }

  #index-btn {
    padding: 10px 24px; background: var(--primary); color: #fff;
    border: none; border-radius: 8px; font-size: 0.95rem;
    cursor: pointer; font-weight: 500;
  }
  #index-btn:hover { background: var(--primary-hover); }
  #index-btn:disabled { background: #93c5fd; cursor: not-allowed; }

  #index-progress { display: none; margin-top: 16px; color: var(--text); font-size: 0.9rem; }
  #index-error { display: none; margin-top: 12px; color: var(--danger); font-size: 0.9rem; }

  /* ===== Chat ===== */
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .message {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 16px;
    line-height: 1.5;
    font-size: 0.95rem;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .user {
    align-self: flex-end;
    background: var(--primary);
    color: #fff;
    border-bottom-right-radius: 4px;
  }

  .assistant {
    align-self: flex-start;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
  }

  .sources-toggle {
    display: inline-block; margin-top: 8px; font-size: 0.8rem;
    color: var(--primary); cursor: pointer; user-select: none;
  }
  .sources-toggle:hover { text-decoration: underline; }

  .sources {
    display: none; margin-top: 8px; padding: 10px;
    background: #f9fafb; border-radius: 8px;
    font-size: 0.82rem; color: var(--text);
  }
  .sources.open { display: block; }

  .source-item { padding: 6px 0; border-bottom: 1px solid var(--border); }
  .source-item:last-child { border-bottom: none; }
  .source-title { font-weight: 600; }
  .source-chapter { color: var(--text-muted); }
  .source-score { color: var(--text-faint); font-size: 0.75rem; }
  .source-text { margin-top: 4px; color: var(--text-muted); font-style: italic; }

  .loading-dots span {
    animation: blink 1.4s infinite both;
    font-size: 1.5rem;
  }
  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes blink {
    0%, 80%, 100% { opacity: 0.2; }
    40% { opacity: 1; }
  }

  /* ===== Input bar ===== */
  #input-bar {
    display: flex; gap: 8px; padding: 12px 16px;
    background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0;
  }

  #query-input {
    flex: 1; padding: 10px 14px;
    border: 1px solid #d1d5db; border-radius: 20px;
    font-size: 0.95rem; outline: none;
  }
  #query-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.15); }

  #send-btn {
    padding: 10px 20px; background: var(--primary); color: #fff;
    border: none; border-radius: 20px; font-size: 0.95rem;
    cursor: pointer; font-weight: 500;
  }
  #send-btn:hover { background: var(--primary-hover); }
  #send-btn:disabled { background: #93c5fd; cursor: not-allowed; }

  /* ===== Logs panel ===== */
  .logs-panel {
    width: var(--logs-w);
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
    transition: margin-right 0.2s ease;
  }

  .logs-panel.collapsed {
    margin-right: calc(-1 * var(--logs-w));
  }

  .logs-header {
    padding: 10px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .logs-header-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text);
  }

  .logs-close {
    background: none; border: none; cursor: pointer;
    font-size: 1.1rem; color: var(--text-muted); padding: 2px 4px;
  }
  .logs-close:hover { color: var(--text); }

  .logs-filters {
    display: flex;
    gap: 4px;
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .log-filter-btn {
    padding: 3px 8px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    background: var(--surface);
    color: var(--text-muted);
  }
  .log-filter-btn:hover { background: var(--bg); }
  .log-filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

  .logs-content {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 0.72rem;
    line-height: 1.6;
  }

  .log-entry {
    padding: 2px 14px;
    white-space: pre-wrap;
    word-break: break-all;
  }
  .log-entry:hover { background: var(--bg); }

  .log-ts { color: var(--text-faint); }
  .log-level-INFO { color: #2563eb; }
  .log-level-WARNING { color: #d97706; }
  .log-level-ERROR { color: #dc2626; font-weight: 600; }
  .log-level-DEBUG { color: var(--text-faint); }

  /* ===== Markdown in messages ===== */
  .message.assistant p { margin: 0 0 8px 0; }
  .message.assistant p:last-child { margin-bottom: 0; }
  .message.assistant ul, .message.assistant ol { margin: 4px 0 8px 20px; }
  .message.assistant li { margin: 2px 0; }
  .message.assistant strong { font-weight: 600; }
  .message.assistant em { font-style: italic; }
  .message.assistant code {
    background: rgba(0,0,0,0.06); padding: 1px 4px; border-radius: 3px;
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 0.88em;
  }
  [data-theme="dark"] .message.assistant code { background: rgba(255,255,255,0.08); }
  .message.assistant blockquote {
    border-left: 3px solid var(--primary);
    padding-left: 10px;
    margin: 8px 0;
    color: var(--text-muted);
  }
  .message.assistant h1, .message.assistant h2, .message.assistant h3 {
    font-size: 1em;
    font-weight: 600;
    margin: 8px 0 4px 0;
  }

  /* ===== Dark mode toggle ===== */
  #theme-toggle {
    background: none; border: none; color: #fff; cursor: pointer;
    font-size: 1.1rem; padding: 4px 6px; border-radius: 4px;
  }
  #theme-toggle:hover { background: rgba(255,255,255,0.15); }

  /* ===== Responsive ===== */
  @media (max-width: 768px) {
    .sidebar { position: absolute; left: 0; top: 0; bottom: 0; z-index: 20; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
    .sidebar.collapsed { margin-left: calc(-1 * var(--sidebar-w)); }
    .logs-panel { position: absolute; right: 0; top: 0; bottom: 0; z-index: 20; box-shadow: -2px 0 8px rgba(0,0,0,0.1); }
    .logs-panel.collapsed { margin-right: calc(-1 * var(--logs-w)); }
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <button id="sidebar-toggle" title="Toggle library sidebar">&#9776;</button>
    <h1>LibraryAI</h1>
  </div>
  <div class="header-controls">
    <select id="query-type">
      <option value="qa">Q&amp;A</option>
      <option value="recommendation">Recommendation</option>
      <option value="passage_location">Passage Location</option>
      <option value="character_evolution">Character Evolution</option>
    </select>
    <button id="new-chat-btn" title="Start a new conversation">New Chat</button>
    <button id="reindex-btn" style="display:none;">Re-index</button>
    <button id="logs-toggle-btn" title="Toggle logs panel">Logs</button>
    <button id="theme-toggle" title="Toggle dark mode">&#9789;</button>
  </div>
</header>

<div class="app-body">
  <!-- Sidebar -->
  <div class="sidebar collapsed" id="sidebar">
    <div class="sidebar-header">Library</div>
    <div class="sidebar-content" id="sidebar-content">
      <div class="sidebar-loading" id="sidebar-loading">Loading library...</div>
    </div>
    <button class="summarize-btn" id="summarize-btn">Summarize Selection</button>
  </div>

  <!-- Main area -->
  <div class="main-area">
    <div class="scope-badge-bar" id="scope-badge-bar">
      <span class="scope-badge-label">Scope:</span>
      <span class="scope-badge" id="scope-badge">
        <span id="scope-badge-text"></span>
        <button id="scope-clear-btn" title="Clear scope">&times;</button>
      </span>
    </div>

    <div id="setup-banner">
      <h2>Welcome to LibraryAI</h2>
      <p>No index found. Point to your EPUB library and build the index to get started.</p>
      <input type="text" id="library-dir" placeholder="Path to EPUB directory (leave empty for default)">
      <button id="index-btn">Build Index</button>
      <div id="index-progress"></div>
      <div id="index-error"></div>
    </div>

    <div id="chat"></div>

    <div id="input-bar">
      <input type="text" id="query-input" placeholder="Ask about your library..." autocomplete="off">
      <button id="send-btn">Send</button>
    </div>
  </div>

  <!-- Logs panel -->
  <div class="logs-panel collapsed" id="logs-panel">
    <div class="logs-header">
      <span class="logs-header-title">Logs</span>
      <button class="logs-close" id="logs-close-btn">&times;</button>
    </div>
    <div class="logs-filters">
      <button class="log-filter-btn active" data-level="">ALL</button>
      <button class="log-filter-btn" data-level="INFO">INFO</button>
      <button class="log-filter-btn" data-level="WARNING">WARN</button>
      <button class="log-filter-btn" data-level="ERROR">ERROR</button>
    </div>
    <div class="logs-content" id="logs-content"></div>
  </div>
</div>

<script>
(function() {
  // DOM elements
  const chat = document.getElementById("chat");
  const input = document.getElementById("query-input");
  const sendBtn = document.getElementById("send-btn");
  const queryType = document.getElementById("query-type");
  const setupBanner = document.getElementById("setup-banner");
  const indexBtn = document.getElementById("index-btn");
  const libraryDirInput = document.getElementById("library-dir");
  const indexProgress = document.getElementById("index-progress");
  const indexError = document.getElementById("index-error");
  const reindexBtn = document.getElementById("reindex-btn");
  const newChatBtn = document.getElementById("new-chat-btn");
  const sidebarToggle = document.getElementById("sidebar-toggle");
  const sidebar = document.getElementById("sidebar");
  const sidebarContent = document.getElementById("sidebar-content");
  const sidebarLoading = document.getElementById("sidebar-loading");
  const scopeBadgeBar = document.getElementById("scope-badge-bar");
  const scopeBadge = document.getElementById("scope-badge");
  const scopeBadgeText = document.getElementById("scope-badge-text");
  const scopeClearBtn = document.getElementById("scope-clear-btn");
  const logsToggleBtn = document.getElementById("logs-toggle-btn");
  const logsPanel = document.getElementById("logs-panel");
  const logsCloseBtn = document.getElementById("logs-close-btn");
  const logsContent = document.getElementById("logs-content");
  const summarizeBtn = document.getElementById("summarize-btn");
  const themeToggle = document.getElementById("theme-toggle");

  // State
  let sessionId = null;
  let currentScope = null;  // { type: "book"|"series", title?: string, name?: string }
  let pollTimer = null;
  let logsTimer = null;
  let logFilterLevel = "";

  // --- Utilities ---

  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function scrollToBottom() {
    chat.scrollTop = chat.scrollHeight;
  }

  function addMessage(role, content) {
    const div = document.createElement("div");
    div.className = "message " + role;
    div.innerHTML = content;
    chat.appendChild(div);
    scrollToBottom();
    return div;
  }

  function addLoadingIndicator() {
    return addMessage("assistant", '<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>');
  }

  function buildSourcesHtml(contexts) {
    if (!contexts || contexts.length === 0) return "";
    let html = '<span class="sources-toggle">Show sources (' + contexts.length + ')</span>';
    html += '<div class="sources">';
    for (const ctx of contexts) {
      html += '<div class="source-item">';
      html += '<div class="source-title">' + escapeHtml(ctx.book_title || "Unknown") + '</div>';
      if (ctx.book_author) {
        html += '<div class="source-chapter">by ' + escapeHtml(ctx.book_author) + '</div>';
      }
      if (ctx.chapter_title) {
        html += '<div class="source-chapter">Chapter: ' + escapeHtml(ctx.chapter_title) + '</div>';
      }
      if (ctx.series_name) {
        html += '<div class="source-chapter">Series: ' + escapeHtml(ctx.series_name) + '</div>';
      }
      if (ctx.similarity_score != null) {
        html += '<div class="source-score">Similarity: ' + ctx.similarity_score.toFixed(4) + '</div>';
      }
      if (ctx.text) {
        const preview = ctx.text.length > 200 ? ctx.text.slice(0, 200) + "..." : ctx.text;
        html += '<div class="source-text">' + escapeHtml(preview) + '</div>';
      }
      html += '</div>';
    }
    html += '</div>';
    return html;
  }

  function setChatEnabled(enabled) {
    input.disabled = !enabled;
    sendBtn.disabled = !enabled;
  }

  function showSetupBanner() {
    setupBanner.style.display = "block";
    setChatEnabled(false);
  }

  function hideSetupBanner() {
    setupBanner.style.display = "none";
    setChatEnabled(true);
  }

  // --- Scope management ---

  function setScope(scope) {
    currentScope = scope;
    if (scope) {
      const label = scope.type === "series"
        ? scope.name
        : scope.title;
      scopeBadgeText.textContent = label;
      scopeBadgeBar.classList.add("visible");
      summarizeBtn.classList.add("visible");
      summarizeBtn.textContent = "Summarize " + (scope.type === "series" ? "Series" : "Book");
    } else {
      scopeBadgeBar.classList.remove("visible");
      summarizeBtn.classList.remove("visible");
    }
    // Update active state in sidebar
    document.querySelectorAll(".scope-item").forEach(function(el) {
      el.classList.remove("active");
    });
    if (!scope) {
      const allBtn = document.querySelector('.scope-item[data-scope-type="all"]');
      if (allBtn) allBtn.classList.add("active");
    }
  }

  scopeClearBtn.addEventListener("click", function() {
    setScope(null);
  });

  // --- Sidebar ---

  sidebarToggle.addEventListener("click", function() {
    sidebar.classList.toggle("collapsed");
  });

  async function loadLibrary() {
    try {
      const res = await fetch("/api/library");
      if (!res.ok) {
        sidebarLoading.textContent = "Library not available";
        return;
      }
      const data = await res.json();
      renderSidebar(data);
    } catch (err) {
      sidebarLoading.textContent = "Could not load library";
    }
  }

  function renderSidebar(data) {
    const series = data.series || {};
    const ungrouped = data.ungrouped || [];

    let html = '';

    // "All" option
    html += '<div class="scope-item active" data-scope-type="all">All Books</div>';

    // Series groups
    const seriesNames = Object.keys(series).sort();
    for (const name of seriesNames) {
      const books = series[name];
      html += '<div class="series-header" data-series="' + escapeHtml(name) + '">';
      html += '<span class="series-arrow">&#9654;</span> ' + escapeHtml(name);
      html += '</div>';
      html += '<div class="series-books">';
      for (const book of books) {
        const title = book.title || book;
        html += '<div class="scope-item book-item" data-scope-type="book" data-title="' + escapeHtml(title) + '">';
        html += escapeHtml(title);
        html += '</div>';
      }
      html += '</div>';
    }

    // Ungrouped books
    if (ungrouped.length > 0) {
      html += '<div class="series-header"><span class="series-arrow">&#9654;</span> Ungrouped</div>';
      html += '<div class="series-books">';
      for (const book of ungrouped) {
        const title = book.title || book;
        html += '<div class="scope-item book-item" data-scope-type="book" data-title="' + escapeHtml(title) + '">';
        html += escapeHtml(title);
        html += '</div>';
      }
      html += '</div>';
    }

    sidebarContent.innerHTML = html;

    // Event delegation for sidebar clicks
    sidebarContent.addEventListener("click", function(e) {
      // Series header toggle
      const header = e.target.closest(".series-header");
      if (header) {
        header.classList.toggle("open");
        // If series header has data-series, clicking sets scope to series
        const seriesName = header.getAttribute("data-series");
        if (seriesName) {
          setScope({ type: "series", name: seriesName });
          header.nextElementSibling.querySelectorAll(".scope-item").forEach(function(el) {
            el.classList.remove("active");
          });
        }
        return;
      }

      // Scope item click
      const item = e.target.closest(".scope-item");
      if (item) {
        const scopeType = item.getAttribute("data-scope-type");
        if (scopeType === "all") {
          setScope(null);
        } else if (scopeType === "book") {
          const title = item.getAttribute("data-title");
          setScope({ type: "book", title: title });
        }
        // Mark active
        document.querySelectorAll(".scope-item").forEach(function(el) {
          el.classList.remove("active");
        });
        item.classList.add("active");
      }
    });
  }

  // --- Sessions ---

  async function createSession() {
    try {
      const res = await fetch("/api/session/new", { method: "POST" });
      const data = await res.json();
      sessionId = data.session_id;
    } catch (err) {
      sessionId = null;
    }
  }

  async function startNewChat() {
    await createSession();
    chat.innerHTML = "";
    setScope(null);
    addMessage("assistant", "New conversation started. Ask me anything about your library!");
    input.focus();
  }

  newChatBtn.addEventListener("click", startNewChat);

  // --- Summarize ---

  summarizeBtn.addEventListener("click", async function() {
    if (!currentScope) return;

    summarizeBtn.disabled = true;
    const origText = summarizeBtn.textContent;
    summarizeBtn.textContent = "Generating...";

    const body = {
      type: currentScope.type,
      title: currentScope.title || null,
      name: currentScope.name || null,
    };

    try {
      const res = await fetch("/api/summary", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      if (!res.ok) {
        addMessage("assistant", "Summary failed: " + (data.error || "Unknown error"));
        summarizeBtn.disabled = false;
        summarizeBtn.textContent = origText;
        return;
      }

      addMessage("assistant", data.message + " This may take a few minutes...");

      // Poll for completion
      const summaryPoll = setInterval(async function() {
        try {
          const sr = await fetch("/api/summary/status");
          const sd = await sr.json();
          if (!sd.active) {
            clearInterval(summaryPoll);
            summarizeBtn.disabled = false;
            summarizeBtn.textContent = origText;
            if (sd.error) {
              addMessage("assistant", "Summary failed: " + sd.error);
            } else if (sd.result) {
              const sumDiv = addMessage("assistant", "");
              sumDiv.style.whiteSpace = "normal";
              sumDiv.innerHTML = renderMarkdown(sd.result.summary);
            }
          }
        } catch (e) {}
      }, 3000);
    } catch (err) {
      addMessage("assistant", "Error: " + err.message);
      summarizeBtn.disabled = false;
      summarizeBtn.textContent = origText;
    }
  });

  // --- Health check ---

  async function checkHealth() {
    try {
      const res = await fetch("/api/health");
      const data = await res.json();

      if (data.has_index) {
        hideSetupBanner();
        reindexBtn.style.display = "inline-block";
        await createSession();
        addMessage("assistant", "Welcome to LibraryAI! Ask me anything about your ebook library.");
        input.focus();
        loadLibrary();
        sidebar.classList.remove("collapsed");
      } else if (data.indexing) {
        showSetupBanner();
        indexBtn.disabled = true;
        indexProgress.style.display = "block";
        indexProgress.textContent = "Indexing in progress...";
        startPolling();
      } else {
        showSetupBanner();
      }
    } catch (err) {
      addMessage("assistant", "Could not reach the server. Please refresh the page.");
    }
  }

  // --- Indexing ---

  async function startIndexing() {
    indexBtn.disabled = true;
    indexError.style.display = "none";
    indexProgress.style.display = "block";
    indexProgress.textContent = "Starting...";

    const body = {};
    const dir = libraryDirInput.value.trim();
    if (dir) body.library_dir = dir;

    try {
      const res = await fetch("/api/index", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      if (!res.ok) {
        indexError.style.display = "block";
        indexError.textContent = data.error || "Failed to start indexing";
        indexBtn.disabled = false;
        indexProgress.style.display = "none";
        return;
      }

      indexProgress.textContent = data.message;
      startPolling();
    } catch (err) {
      indexError.style.display = "block";
      indexError.textContent = "Could not reach the server: " + err.message;
      indexBtn.disabled = false;
      indexProgress.style.display = "none";
    }
  }

  function startPolling() {
    if (pollTimer) return;
    pollTimer = setInterval(pollStatus, 2000);
  }

  async function pollStatus() {
    try {
      const res = await fetch("/api/index/status");
      const data = await res.json();

      if (data.active) {
        indexProgress.textContent = data.progress || data.message || "Working...";
      } else if (data.error) {
        clearInterval(pollTimer);
        pollTimer = null;
        indexProgress.style.display = "none";
        indexError.style.display = "block";
        indexError.textContent = "Indexing failed: " + data.error;
        indexBtn.disabled = false;
      } else {
        clearInterval(pollTimer);
        pollTimer = null;
        hideSetupBanner();
        reindexBtn.style.display = "inline-block";
        await createSession();
        addMessage("assistant", "Index built successfully! Ask me anything about your ebook library.");
        input.focus();
        loadLibrary();
        sidebar.classList.remove("collapsed");
      }
    } catch (err) {
      // Keep polling on transient errors
    }
  }

  indexBtn.addEventListener("click", startIndexing);

  // --- Re-index ---

  reindexBtn.addEventListener("click", async function() {
    reindexBtn.disabled = true;
    reindexBtn.textContent = "Re-indexing...";
    try {
      const res = await fetch("/api/index", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      });
      const data = await res.json();
      if (!res.ok) {
        addMessage("assistant", "Re-index failed: " + (data.error || "Unknown error"));
        reindexBtn.disabled = false;
        reindexBtn.textContent = "Re-index";
        return;
      }
      addMessage("assistant", data.message + " This may take a few minutes...");
      const reindexPoll = setInterval(async function() {
        try {
          const sr = await fetch("/api/index/status");
          const sd = await sr.json();
          if (!sd.active) {
            clearInterval(reindexPoll);
            reindexBtn.disabled = false;
            reindexBtn.textContent = "Re-index";
            if (sd.error) {
              addMessage("assistant", "Re-indexing failed: " + sd.error);
            } else {
              addMessage("assistant", "Re-indexing complete! Your library has been updated.");
              loadLibrary();
            }
          }
        } catch (e) {}
      }, 2000);
    } catch (err) {
      addMessage("assistant", "Error: Could not reach the server. " + err.message);
      reindexBtn.disabled = false;
      reindexBtn.textContent = "Re-index";
    }
  });

  // --- Query ---

  async function sendQuery() {
    const text = input.value.trim();
    if (!text) return;

    input.value = "";
    sendBtn.disabled = true;

    addMessage("user", escapeHtml(text));

    const body = {
      query: text,
      query_type: queryType.value,
      session_id: sessionId,
    };
    if (currentScope) {
      body.scope = currentScope;
    }

    // Create the assistant message div for streaming
    const msgDiv = document.createElement("div");
    msgDiv.className = "message assistant";
    msgDiv.innerHTML = '<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>';
    chat.appendChild(msgDiv);
    scrollToBottom();

    let fullText = "";
    let contexts = null;

    try {
      const res = await fetch("/api/query/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const errData = await res.json();
        msgDiv.innerHTML = escapeHtml("Error: " + (errData.error || "Request failed"));
        return;
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";
      let started = false;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop();  // Keep incomplete line

        for (const line of lines) {
          if (!line.startsWith("data: ")) continue;
          const jsonStr = line.slice(6);
          let event;
          try { event = JSON.parse(jsonStr); } catch (e) { continue; }

          if (event.session_id) sessionId = event.session_id;

          if (event.type === "no_results") {
            msgDiv.innerHTML = escapeHtml(event.answer);
          } else if (event.type === "contexts") {
            contexts = event.contexts;
          } else if (event.type === "token") {
            if (!started) {
              msgDiv.innerHTML = "";
              msgDiv.style.whiteSpace = "normal";
              started = true;
            }
            fullText += event.token;
            msgDiv.innerHTML = renderMarkdown(fullText);
            scrollToBottom();
          } else if (event.type === "done") {
            // Append sources
            if (contexts) {
              msgDiv.innerHTML = renderMarkdown(fullText) + buildSourcesHtml(contexts);
            }
          } else if (event.type === "error") {
            msgDiv.innerHTML = escapeHtml("Error: " + event.error);
          }
        }
      }

      // If we got no tokens (e.g., error before streaming started), show what we have
      if (!started && fullText === "" && !msgDiv.innerHTML.startsWith("Error")) {
        msgDiv.innerHTML = renderMarkdown(fullText) || "No response received.";
      }

    } catch (err) {
      msgDiv.innerHTML = escapeHtml("Error: Could not reach the server. " + err.message);
    } finally {
      sendBtn.disabled = false;
      input.focus();
    }
  }

  sendBtn.addEventListener("click", sendQuery);
  input.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendQuery();
    }
  });

  // --- Sources toggle (event delegation) ---

  chat.addEventListener("click", function(e) {
    if (e.target.classList.contains("sources-toggle")) {
      const sources = e.target.nextElementSibling;
      if (sources) {
        sources.classList.toggle("open");
        e.target.textContent = sources.classList.contains("open")
          ? "Hide sources (" + sources.children.length + ")"
          : "Show sources (" + sources.children.length + ")";
      }
    }
  });

  // --- Logs panel ---

  logsToggleBtn.addEventListener("click", function() {
    logsPanel.classList.toggle("collapsed");
    if (!logsPanel.classList.contains("collapsed")) {
      fetchLogs();
      startLogsPolling();
    } else {
      stopLogsPolling();
    }
  });

  logsCloseBtn.addEventListener("click", function() {
    logsPanel.classList.add("collapsed");
    stopLogsPolling();
  });

  // Log filter buttons
  document.querySelectorAll(".log-filter-btn").forEach(function(btn) {
    btn.addEventListener("click", function() {
      document.querySelectorAll(".log-filter-btn").forEach(function(b) { b.classList.remove("active"); });
      btn.classList.add("active");
      logFilterLevel = btn.getAttribute("data-level");
      fetchLogs();
    });
  });

  async function fetchLogs() {
    try {
      let url = "/api/logs?limit=200";
      if (logFilterLevel) url += "&level=" + logFilterLevel;
      const res = await fetch(url);
      const logs = await res.json();
      renderLogs(logs);
    } catch (err) {
      logsContent.innerHTML = '<div class="log-entry" style="color:var(--danger)">Could not fetch logs</div>';
    }
  }

  function renderLogs(logs) {
    const wasAtBottom = logsContent.scrollTop + logsContent.clientHeight >= logsContent.scrollHeight - 20;
    let html = "";
    for (const entry of logs) {
      const lvlClass = "log-level-" + entry.level;
      html += '<div class="log-entry">';
      html += '<span class="log-ts">' + escapeHtml(entry.timestamp) + '</span> ';
      html += '<span class="' + lvlClass + '">' + escapeHtml(entry.level.padEnd(7)) + '</span> ';
      html += escapeHtml(entry.message);
      html += '</div>';
    }
    logsContent.innerHTML = html;
    if (wasAtBottom) {
      logsContent.scrollTop = logsContent.scrollHeight;
    }
  }

  function startLogsPolling() {
    stopLogsPolling();
    logsTimer = setInterval(fetchLogs, 3000);
  }

  function stopLogsPolling() {
    if (logsTimer) {
      clearInterval(logsTimer);
      logsTimer = null;
    }
  }

  // --- Dark mode ---

  themeToggle.addEventListener("click", function() {
    const html = document.documentElement;
    const isDark = html.getAttribute("data-theme") === "dark";
    html.setAttribute("data-theme", isDark ? "light" : "dark");
    themeToggle.textContent = isDark ? "\u263D" : "\u2600";
    localStorage.setItem("theme", isDark ? "light" : "dark");
  });

  // Restore saved theme
  (function() {
    const saved = localStorage.getItem("theme");
    if (saved === "dark") {
      document.documentElement.setAttribute("data-theme", "dark");
      themeToggle.textContent = "\u2600";
    }
  })();

  // --- Simple markdown renderer ---

  function renderMarkdown(text) {
    // Escape HTML first for safety
    let html = escapeHtml(text);

    // Code blocks (```)
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Italic
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    // Headers (###, ##, #)
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
    // Blockquotes
    html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
    // Unordered lists
    html = html.replace(/^[*-] (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    // Ordered lists
    html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
    // Paragraphs (double newlines)
    html = html.replace(/\n\n/g, '</p><p>');
    html = '<p>' + html + '</p>';
    // Clean up empty paragraphs
    html = html.replace(/<p>\s*<\/p>/g, '');
    // Single newlines inside paragraphs
    html = html.replace(/\n/g, '<br>');

    return html;
  }

  // --- Init ---
  checkHealth();

})();
</script>

</body>
</html>
